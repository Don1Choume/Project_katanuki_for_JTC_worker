# TDD (テスト駆動開発) マニュアル - 初心者向け

このマニュアルは、和田卓人氏が提唱するTDD（テスト駆動開発）の考え方に基づき、初心者の方でもTDDを実践できるよう、その概念、メリット、具体的なサイクル、そして実践例を詳しく解説します。

## 1. TDDとは何か？

TDDは「テストを先に書く」開発手法です。コードを書く前に、そのコードが満たすべき要件をテストコードとして記述し、そのテストが失敗することを確認（Red）、次にそのテストをパスする最小限のプロダクトコードを書き（Green）、最後にコードを改善（Refactor）するというサイクルを繰り返します。

### TDDの目的

- **設計の改善:** テストしやすいコードは、疎結合で凝集度が高く、良い設計になりやすいです。
- **品質の向上:** テストが常に存在するため、バグの早期発見と修正が可能です。
- **自信を持って変更できる:** テストスイートがあることで、既存の機能が壊れていないことを確認しながら、安心してコードの変更やリファクタリングができます。
- **ドキュメントとしてのテスト:** テストコードは、そのコードがどのように使われるべきかを示す生きたドキュメントとなります。

## 2. TDDの3つの法則 (Red-Green-Refactor)

TDDは、以下の3つのシンプルな法則に従って進められます。このサイクルを非常に短い間隔（数分程度）で繰り返すことが重要です。

### 2.1. Red (赤) - 失敗するテストを書く

- **目的:** これから実装する機能の要件を明確にし、その機能がまだ存在しない（または正しく動作しない）ことを確認する。
- **手順:**
    1.  **テストを追加:** 実装したい機能の、最も小さな単位の振る舞いを検証するテストコードを書きます。
    2.  **テストを実行:** 書いたテストを実行し、**必ず失敗することを確認します**。これは、テストコード自体が正しく書かれているか（テストが壊れていないか）、そしてその機能がまだ実装されていないことを確認するためです。
    3.  **失敗の確認:** テストが失敗する理由（例: 関数が存在しない、期待する値と異なる）を理解します。

### 2.2. Green (緑) - テストをパスする最小限のコードを書く

- **目的:** Redフェーズで失敗したテストを、**最小限の変更で**パスさせる。
- **手順:**
    1.  **プロダクトコードを追加:** 失敗しているテストをパスさせるために、必要最小限のプロダクトコードを書きます。
    2.  **テストを実行:** 再びテストを実行し、**すべてのテストがパスすることを確認します**。
    3.  **パスの確認:** テストがパスしたことを確認します。この段階では、コードの美しさや効率は気にしません。とにかくテストをパスさせることが最優先です。

### 2.3. Refactor (リファクタリング) - コードを改善する

- **目的:** Greenフェーズで書いたコードを、テストを壊さずに改善する。
- **手順:**
    1.  **コードの改善:** 重複の排除、命名の改善、関数の分割、アルゴリズムの最適化など、コードの品質を高めるための変更を行います。
    2.  **テストを実行:** リファクタリングのたびに、**すべてのテストを実行し、パスすることを確認します**。これにより、リファクタリングによって既存の機能が壊れていないことを保証できます。
    3.  **安全な変更:** テストスイートがセーフティネットとなるため、自信を持ってコードを改善できます。

## 3. 和田卓人氏のTDDへの強調点

和田卓人氏は、TDDを単なるテスト手法ではなく、**「設計のプラクティス」**として捉えることを強調しています。

-   **「テスト容易性」の追求:** テストしやすいコードは、自然と疎結合で凝集度が高く、変更に強い良い設計になります。テストを先に書くことで、テストしにくい設計になることを防ぎます。
-   **「小さなステップ」の重要性:** Red-Green-Refactorのサイクルを極めて短い時間（数分）で回すことで、フィードバックループが高速になり、開発者は常に「今、何が問題なのか」を明確に把握できます。これにより、迷いや手戻りが減り、生産性が向上します。
-   **「動く設計」:** テストがパスしている状態は、その時点での設計が「動いている」ことを保証します。テストスイートは、設計の意図を明確にし、将来の変更に対する安全弁となります。
-   **「自信」と「安心」:** 常にテストがパスしている状態を維持することで、開発者は自分の書いたコード、そしてシステム全体に対して自信を持つことができます。これにより、新しい機能の追加や大規模なリファクタリングも安心して行えます。

## 4. 実践例: シンプルな計算機の実装 (Python + Pytest)

ここでは、`add`関数をTDDで実装する例を示します。

### 前提

-   `pytest`がインストールされていること (`uv add pytest`)
-   プロジェクトのルートディレクトリにいること

### 4.1. Red: 失敗するテストを書く

`tests/test_calculator.py`というファイルを作成し、以下の内容を記述します。

```python
# tests/test_calculator.py

def test_add_two_numbers():
    """2つの数値を加算するテスト。"""
    # まだadd関数は存在しないので、このテストは失敗するはず
    assert add(1, 2) == 3
```

ターミナルでテストを実行します。

```bash
pytest tests/test_calculator.py
```

**結果:** `NameError: name 'add' is not defined` のようなエラーでテストが失敗することを確認します。これが「Red」の状態です。

### 4.2. Green: テストをパスする最小限のコードを書く

`analysis_lib/calculator.py`というファイルを作成し、`add`関数を実装します。

```python
# analysis_lib/calculator.py

def add(a: int, b: int) -> int:
    """2つの数値を加算します。"""
    return a + b
```

`tests/test_calculator.py`を修正し、`add`関数をインポートします。

```python
# tests/test_calculator.py

from analysis_lib.calculator import add # 追加

def test_add_two_numbers():
    """2つの数値を加算するテスト。"""
    assert add(1, 2) == 3
```

再度テストを実行します。

```bash
pytest tests/test_calculator.py
```

**結果:** テストがパスすることを確認します。これが「Green」の状態です。

### 4.3. Refactor: コードを改善する

この例では`add`関数が非常にシンプルなので、大きなリファクタリングの必要はありません。しかし、もし複雑なロジックが含まれていたり、重複があったりした場合は、ここでコードを改善します。

例えば、もし`add`関数が以下のように書かれていたとします。

```python
# analysis_lib/calculator.py (リファクタリング前)

def add(a: int, b: int) -> int:
    temp_sum = a
    temp_sum = temp_sum + b
    return temp_sum
```

これをより簡潔にリファクタリングします。

```python
# analysis_lib/calculator.py (リファクタリング後)

def add(a: int, b: int) -> int:
    """2つの数値を加算します。"""
    return a + b
```

リファクタリング後も、必ずテストを実行して、すべてのテストがパスすることを確認します。

```bash
pytest tests/test_calculator.py
```

**結果:** テストがパスすることを確認します。

### 4.4. 次のテスト (Red)

新しい要件（例: 負の数の加算）を追加する場合、再びRedフェーズから始めます。

`tests/test_calculator.py`に新しいテストを追加します。

```python
# tests/test_calculator.py

from analysis_lib.calculator import add

def test_add_two_numbers():
    """2つの数値を加算するテスト。"""
    assert add(1, 2) == 3

def test_add_negative_numbers(): # 新しいテスト
    """負の数値を加算するテスト。"""
    assert add(-1, -2) == -3
```

テストを実行し、新しいテストが失敗することを確認します（この場合は既存の`add`関数でパスしてしまうかもしれませんが、もし複雑なロジックで失敗するケースであれば、ここでRedを確認します）。

このように、Red-Green-Refactorのサイクルを繰り返すことで、着実に機能を実装し、同時に堅牢なテストスイートと良い設計を構築していきます。

## 5. 初心者が陥りやすい落とし穴とヒント

-   **テストを書くのが面倒:** 最初は慣れないため時間がかかると感じるかもしれませんが、長期的に見ればバグ修正の手間が減り、開発速度が向上します。
-   **大きすぎるテスト:** 一度に多くの機能をテストしようとせず、**最も小さな単位の振る舞い**からテストを書き始めましょう。
-   **テストが失敗しない:** テストを書いたら、必ず一度は失敗することを確認してください。失敗しないテストは、そのテストが本当に機能しているかどうかが不明です。
-   **リファクタリングを怠る:** Greenになったらすぐに次のRedに行きたくなるかもしれませんが、リファクタリングは設計を改善し、将来の変更を容易にするために不可欠です。
-   **プロダクトコードを書きすぎる:** Greenフェーズでは、テストをパスする**最小限のコード**を書くことに徹しましょう。余計なコードはリファクタリングフェーズで追加・改善します。
-   **外部依存のテスト:** データベースや外部APIなど、外部に依存するテストは、テストの実行速度を遅くし、不安定にする可能性があります。これらはモック（Mock）やスタブ（Stub）を使って依存を排除することを検討しましょう。

TDDは、練習すればするほど身につくスキルです。焦らず、小さな成功体験を積み重ねていきましょう。
